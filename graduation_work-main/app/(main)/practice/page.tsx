//–ú–∞—à–∞

// =======================
// –°–µ—Ä–≤–µ—Ä–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–æ—Ä—ñ–Ω–∫–∏ Practice
// =======================

import PracticeClient from "@/app/(main)/practice/PracticeClient";
// –Ü–º–ø–æ—Ä—Ç –∫–ª—ñ—î–Ω—Ç—Å—å–∫–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ PracticeClient, —è–∫–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø—Ä–∞–∫—Ç–∏–∫–∏ (React Client Component)

import { getUserProgress } from "@/db/queries";
// –Ü–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

import fs from "fs";
// –ú–æ–¥—É–ª—å Node.js –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ —Ñ–∞–π–ª–æ–≤–æ—é —Å–∏—Å—Ç–µ–º–æ—é (—á–∏—Ç–∞–Ω–Ω—è JSON, DOCX —Ç–æ—â–æ)

import path from "path";
// –ú–æ–¥—É–ª—å Node.js –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ —à–ª—è—Ö–∞–º–∏ –¥–æ —Ñ–∞–π–ª—ñ–≤

import { redirect } from "next/navigation";
// –§—É–Ω–∫—Ü—ñ—è Next.js –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–∞ —ñ–Ω—à—É —Å—Ç–æ—Ä—ñ–Ω–∫—É

// =======================
// –ì–æ–ª–æ–≤–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
// =======================
const PracticePage = async () => {
  // –û—Ç—Ä–∏–º—É—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ –±–∞–∑–∏
  const userProgress = await getUserProgress();

  // üîê –ë–∞–∑–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ–º–∞—î –∞–±–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–≥—ñ–æ–Ω—É –Ω–µ–º–∞—î ‚Üí —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤–∏–±–æ—Ä—É –∫—Ä–∞—ó–Ω
  if (!userProgress || !userProgress.activeRegion) {
    redirect("/countries");
  }

  // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π —Ä–µ–≥—ñ–æ–Ω —ñ –∫—Ä–∞—ó–Ω—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  const activeRegion = userProgress.activeRegion;
  const countryId = activeRegion.countryId;

  // –í–∏–∑–Ω–∞—á–∞—î–º–æ —à–ª—è—Ö–∏ –¥–æ –º–µ–¥—ñ–∞-—Ñ–∞–π–ª—ñ–≤
  const videoSrc = `/videos/${activeRegion.id}.mp4`; // –≤—ñ–¥–µ–æ –¥–ª—è —Ä–µ–≥—ñ–æ–Ω—É
  const fileSrc = `/materials/${activeRegion.id}.docx`; // —Ñ–∞–π–ª –∑ –º–∞—Ç–µ—Ä—ñ–∞–ª–∞–º–∏ —Ä–µ–≥—ñ–æ–Ω—É
  const fileSrcCountry = `/materials/countries/${countryId}.docx`; // —Ñ–∞–π–ª –∑ –º–∞—Ç–µ—Ä—ñ–∞–ª–∞–º–∏ –¥–ª—è –∫—Ä–∞—ó–Ω–∏

  // –§–æ—Ä–º—É—î–º–æ —à–ª—è—Ö –¥–æ JSON –∑ —Å–ª–æ–≤–∞–º–∏ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏
  const filePath = path.join(
    process.cwd(), // –ø–æ—Ç–æ—á–Ω–∞ —Ä–æ–±–æ—á–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è –ø—Ä–æ—î–∫—Ç—É
    "public",      // –ø–∞–ø–∫–∞ public
    "words",       // –ø—ñ–¥–ø–∞–ø–∫–∞ words
    `${activeRegion.id}.json` // –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Ñ–∞–π–ª –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–≥—ñ–æ–Ω—É
  );

  // –ß–∏—Ç–∞—î–º–æ —Ñ–∞–π–ª JSON –∑ –¥–∏—Å–∫—É
  const raw = fs.readFileSync(filePath, "utf8");

  // –ü–∞—Ä—Å–∏–º–æ JSON —Ç–∞ —Ñ–æ—Ä–º–∞—Ç—É—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–∞–∫—Ç–∏–∫–∏
  const words = JSON.parse(raw).map((item: any) => ({
    ...item, 
    audio: item.audio.replace("REGION_ID", activeRegion.id.toString()),
    // –ó–∞–º—ñ–Ω—é—î–º–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä REGION_ID –Ω–∞ —Ä–µ–∞–ª—å–Ω–∏–π id —Ä–µ–≥—ñ–æ–Ω—É –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ –∞—É–¥—ñ–æ
  }));

  // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–ª—ñ—î–Ω—Ç—Å—å–∫–æ—ó —á–∞—Å—Ç–∏–Ω–∏ PracticeClient –∑ —É—Å—ñ–º–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏
  return (
    <PracticeClient
      userProgress={userProgress} // –ø—Ä–æ–≥—Ä–µ—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
      activeRegion={activeRegion} // –∞–∫—Ç–∏–≤–Ω–∏–π —Ä–µ–≥—ñ–æ–Ω
      words={words}               // —Å–ª–æ–≤–∞ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏
      videoSrc={videoSrc}         // –≤—ñ–¥–µ–æ
      fileSrc={fileSrc}           // —Ñ–∞–π–ª —Ä–µ–≥—ñ–æ–Ω—É
      fileSrcCountry={fileSrcCountry} // —Ñ–∞–π–ª –∫—Ä–∞—ó–Ω–∏
    />
  );
};

// =======================
// –ï–∫—Å–ø–æ—Ä—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
// =======================
export default PracticePage;
